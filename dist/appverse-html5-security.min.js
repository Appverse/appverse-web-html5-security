/*! appverse-web-html5-security - v0.5.1 - */
!function(){"use strict";function a(a,b,c){function d(a,b,c){return{response:function(a){var d=a.headers("X-XSRF-Cookie");return b.debug("oauthResponseInterceptor X-XSRF-Cookie: "+d),d&&c.get("Oauth_AccessToken").setFromHeader(d),a}}}c.has("avCacheFactory")||a.factory("avCacheFactory",["$cacheFactory",function(a){return{_browserCache:a("basicCache")}}]),d.$inject=["$q","$log","$injector"],a.factory("oauthResponseInterceptor",d),b.interceptors.push("oauthResponseInterceptor");var e=["$q","$location","$log","SECURITY_GENERAL",function(a,b,c,d){return{responseError:function(e){return 401===e.status&&d.error401Redirect&&(c.error("Error 401 intercepted. Redirecting..."),b.path(d.error401Redirect)),a.reject(e)}}}];a.factory("logsOutUserOn401",e),b.interceptors.push("logsOutUserOn401")}function b(a,b,c,d,e,f,g){a.debug("appverse.security run"),b.$on("$locationChangeStart",function(b){if(c.url()!==(e.loginRequiredRedirect||e.routeDeniedRedirect||e.error401Redirect)&&!f.isRouteAllowed()){var g=d.getCurrentUser();if(g&&g.isLogged&&e.routeDeniedRedirect)return a.debug("Route is denied. Redirecting..."),b.preventDefault(),void c.path(e.routeDeniedRedirect);if(e.loginRequiredRedirect)return a.debug("Login required. Redirecting..."),b.preventDefault(),void c.path(e.loginRequiredRedirect)}}),b.UserService=d,b.AuthenticationService=g}a.$inject=["$provide","$httpProvider","$injector"],b.$inject=["$log","$rootScope","$location","UserService","SECURITY_GENERAL","RoleService","AuthenticationService"],angular.module("appverse.security",["ngCookies","appverse.configuration","ngResource"]).config(a).run(b)}(),function(){"use strict";function a(a,b,c,d,e,f,g){return{sendLoginRequest:function(a){var d=b.encode(a.name+":"+a.password);return c({method:f.loginHTTPMethod,url:f.loginURL,headers:{Authorization:"Basic "+d,"Content-Type":f.Headers_ContentType},timeout:3e4,cache:!1})},sendLogoutRequest:function(){var a=d.defer(),b=this;return c({method:f.logoutHTTPMethod,url:f.logoutURL,headers:{"Content-Type":f.Headers_ContentType},timeout:3e4,cache:!1}).success(function(c,d,e,f){var g=[];g.data=c,g.headers=e,g.status=d,g.config=f,a.resolve(g),b.logOut()}).error(function(b,c){a.reject(b,c)}),a.promise},login:function(b,c,d,e,f){a.setCurrentUser({name:b,roles:c,bToken:d,xsrfToken:e,isLogged:f})},isLoggedIn:function(){var b=a.getCurrentUser();return!!b},logOut:function(){a.removeUser(),g.$emit("$locationChangeStart")}}}a.$inject=["UserService","Base64","$http","$q","$log","SECURITY_GENERAL","$rootScope"],angular.module("appverse.security").factory("AuthenticationService",a)}(),function(){"use strict";function a(a,b,c,d){function e(b){var c=h(a.hash());c&&(n(a.hash()),l(c,b))}function f(){var a=c.getCurrentUser();a&&(p=a.bToken)}function g(){var a=c.getCurrentUser();a&&(q=a.xsrfToken)}function h(a){for(var b=a.split("&"),c={},d=0;d<b.length;d++){var e=b[d].split("="),f=e[0],g=e[1];c[f]=g}if(c.access_token||c.error)return c}function i(a){if("cookies"===a.storage&&b[a.client]){var c=JSON.parse(b[a.client]);l(c,a)}}function j(a,c){a.storage===SECURITY_OAUTH.storage_cookies&&c&&c.access_token&&(b[a.client]=JSON.stringify(c))}function k(a,b){p=b&&b.access_token?b.access_token:o.get();var d=c.getCurrentUser();d&&(d.bToken=p,c.setCurrentUser(d))}function l(a,b){return p=p||{},angular.extend(p,a),m(),j(b,a),k(p),p}function m(){if(p){var a=new Date;a.setSeconds(a.getSeconds()+parseInt(p.expires_in)-60),p.expires_at=a}}function n(b){for(var c,e=b.split("&"),f=0;f<e.length;f++){var g=e[f].split("="),h=g[0],i=g[1];"access_token"==h&&(c=i)}var j=b.substring(0,b.lastIndexOf("?")+1),k=j+"access_token="+c;a.hash(k),d.debug("OauthAccessTokenFactory.removeFragment: hash"+a.hash())}var o={},p=null,q=null;return o.get=function(){return f(),p},o.getXSRF=function(){return g(),q},o.set=function(a){return e(a),i(a),p},o.setFromHeader=function(a){return k(a),a},o.destroy=function(a){return p=null,q=null,delete b[a.client],p},o.expired=function(){return p&&p.expires_at&&p.expires_at<new Date},o}a.$inject=["$location","$cookies","UserService","$log"],angular.module("appverse.security").factory("Oauth_AccessToken",a)}(),function(){"use strict";function a(a,b){var c,d={};return d.set=function(d){return b.debug("OauthEndpointFactory.set"),c=d.site+d.authorizePath+"?response_type=token&client_id="+d.client+"&redirect_uri="+d.redirect+"&scope="+d.scope+"&state="+a.url()},d.get=function(){return b.debug("OauthAccessTokenFactory.get"),c},d.redirect=function(){b.debug("OauthAccessTokenFactory.redirect"),window.location.replace(c)},d}a.$inject=["$location","$log"],angular.module("appverse.security").factory("Oauth_Endpoint",a)}(),function(){"use strict";function a(a,b){return a.wrapRequest(b)}a.$inject=["Oauth_RequestWrapper","Restangular"],angular.module("appverse.security").factory("Oauth_Profile",a)}(),function(){"use strict";function a(a,c,d,e,f){function g(g,h){if(a.debug("OauthRequestWrapperFactory.setRequestHeaders"),a.debug("token: "+g),a.debug("is same domain? "+b(e.BaseUrl,c.url())),g){var i;b(e.BaseUrl,c.url())&&(a.debug("*** isSameDomain"),0===f.XSRFPolicyType?(a.debug("*** case 0"),h.setDefaultHeaders({Authorization:"Bearer"+g,"Content-Type":e.DefaultContentType})):1===f.XSRFPolicyType?(a.debug("*** case 1"),i=d.getXSRF(),h.setDefaultHeaders({Authorization:"Bearer"+g,"Content-Type":e.DefaultContentType,"X-XSRF-TOKEN":i})):2===f.XSRFPolicyType&&(a.debug("*** case 2"),i=c.cookies()[f.XSRFCSRFCookieName],h.setDefaultHeaders({Authorization:"Bearer"+g,"Content-Type":e.DefaultContentType,"X-XSRF-TOKEN":i})))}return h}var h={};return h.wrapRequest=function(b){a.debug("OauthRequestWrapperFactory.wrapRequest");var c=d.get(),e=b;return c?(a.debug("OAuth token is present and valid. The wrapped request is secure."),g(c,b)):a.debug("OAuth token is not present yet. The wrapped request will not be secure."),e},h}function b(a,b){var c=/^(([^:]+):)?\/\/(\w+:{0,1}\w*@)?([\w\.-]*)?(:([0-9]+))?(.*)$/,d=c.exec(a);if(null===d)return!0;var e={protocol:d[2],host:d[4],port:int(d[6])||DEFAULT_PORTS[d[2]]||null,relativeProtocol:void 0===d[2]||""===d[2]};d=URL_MATCH.exec(b);var f={protocol:d[1],host:d[3],port:int(d[5])||DEFAULT_PORTS[d[1]]||null};return(e.protocol==f.protocol||e.relativeProtocol)&&e.host==f.host&&(e.port==f.port||e.relativeProtocol&&f.port==DEFAULT_PORTS[f.protocol])}a.$inject=["$log","$browser","Oauth_AccessToken","REST_CONFIG","SECURITY_GENERAL"],angular.module("appverse.security").factory("Oauth_RequestWrapper",a)}(),function(){"use strict";angular.module("appverse.security").directive("oauth",["SECURITY_OAUTH","Oauth_AccessToken","Oauth_Endpoint","Oauth_Profile","$rootScope","$compile","$http","$templateCache","$log",function(a,b,c,d,e,f,g,h,i){var j={restrict:"AE",replace:!1,scope:{site:"@",client:"@",redirect:"@",scope:"@",flow:"@",view:"@",storage:"@",profile:"@",template:"@"}};return j.link=function(j,k){function l(){i.debug("oauth.init: "),j.site=j.site||a.scopeURL,j.clientID=j.clientID||a.clientID,j.redirect=j.redirect||a.redirect,j.scope=j.scope||a.scope,j.flow=j.flow||a.flow,j.view=j.view||a.view,j.storage=j.storage||a.storage,j.scope=j.scope||a.scope,j.authorizePath=j.authorizePath||a.scope_authorizePath,j.tokenPath=j.tokenPath||a.scope_tokenPath,j.template=j.template||a.scope_template}function m(){i.debug("oauth.compile"),g.get(j.template,{cache:h}).success(function(a){k.html(a),f(k.contents())(j)})}function n(){i.debug("oauth.initProfile");var c=b.get();c&&c.access_token&&a.profile&&(j.profile=d.get())}function o(){i.debug("oauth.initView");var a=b.get();return a?a.access_token?p():a.error?r():void 0:q()}function p(){i.debug("oauth.loggedIn"),e.$broadcast("oauth:success",b.get()),j.show="logout"}function q(){i.debug("oauth.loggedOut"),e.$broadcast("oauth:logout"),j.show="login"}function r(){i.debug("oauth.denied"),j.show="denied",e.$broadcast("oauth:denied")}j.show="none",j.$watch("client",function(){l(),m(),c.set(j),b.set(j),n(),o()}),j.login=function(){i.debug("oauth.scope.login"),c.redirect()},j.logout=function(){i.debug("oauth.scope.logout"),b.destroy(j),q()},j.$on("oauth:template",function(a,b){j.template=b,m(j)})},j}])}(),function(){"use strict";function a(a,b,c,d,e,f){return{validateRoleAdmin:function(){var d=c._browserCache.get("loggedUser").roles;a.debug("roles in session: "+d);var e;if(d&&b.adminRoles){for(var f=0;f<b.adminRoles.length;f++){if(_.contains(d,b.adminRoles[f])){e=!0;break}e=!1}return e}return!1},validateRoleInUserOther:function(a){var b=c._browserCache.get("loggedUser");return!!b&&_.contains(a,b.roles)},isRouteAllowed:function(){if(!e.routes)return!0;var a=e.routes[f.path()];if(a){var b=d.getCurrentUser();return!!b&&_.intersection(b.roles,a).length>0}return!0}}}a.$inject=["$log","AUTHORIZATION_DATA","avCacheFactory","UserService","SECURITY_GENERAL","$location"],angular.module("appverse.security").factory("RoleService",a)}(),function(){"use strict";function a(a,c){return{USER_CACHE_NAME:"loggedUser",_currentUser:null,setCurrentUser:function(d){var e=new b(d.name,d.roles,d.bToken,d.xsrfToken,d.isLogged);c._browserCache.put(this.USER_CACHE_NAME,e),a.debug("New user has been stored to browser cache."),this._currentUser=e},getCurrentUser:function(){if(this._currentUser)return this._currentUser;var a=c._browserCache.get(this.USER_CACHE_NAME);return a&&a.isLogged?(this._currentUser=a,a):null},removeUser:function(){this._currentUser=null,c._browserCache.remove(this.USER_CACHE_NAME),a.debug("User has been removed from browser cache.")}}}function b(a,b,c,d,e){this.name=a,this.roles=b,this.bToken=c,this.xsrfToken=d,this.isLogged=e}a.$inject=["$log","avCacheFactory"],angular.module("appverse.security").factory("UserService",a),b.prototype.print=function(){return"User data. Name:"+this.name+"| Roles: "+this.roles.toString()+"| Bearer Token: "+this.bToken+"| XSRFToken: "+this.xsrfToken+"| Logged: "+this.isLogged}}();
//# sourceMappingURL=appverse-html5-security.min.js.map